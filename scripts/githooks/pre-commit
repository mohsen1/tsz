#!/bin/bash
#
# Pre-commit hook for tsz
#
# Steps:
#   1. Block TypeScript submodule changes
#   2. Clean stale target binaries (cargo clean --doc, old profiles)
#   3. cargo fmt -- check & auto-fix
#   4. cargo clippy -- deny all warnings
#   5. Run all unit tests
#   6. Microbenchmark regression check
#   7. Conformance regression check
#
# Env vars:
#   TSZ_SKIP_HOOKS=1         Skip the entire hook
#   TSZ_SKIP_CONFORMANCE=1   Skip the conformance regression check
#   TSZ_SKIP_BENCH=1         Skip microbenchmark regression check
#   TSZ_SKIP_CLEAN=1         Skip the target cleanup step
#   TSZ_BENCH_UPDATE_BASELINE=1  Refresh local microbenchmark baseline

set -e

# Skip hook entirely if requested
[[ "${TSZ_SKIP_HOOKS:-}" == "1" ]] && exit 0

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../" && pwd)"
cd "$ROOT_DIR"

SKIP_CONFORMANCE="${TSZ_SKIP_CONFORMANCE:-}"
SKIP_BENCH="${TSZ_SKIP_BENCH:-}"
SKIP_CLEAN="${TSZ_SKIP_CLEAN:-}"

echo "ðŸ”§ Pre-commit checks..."

# â”€â”€â”€ 0. Block TypeScript submodule changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

SUBMODULE_CHANGES=$(git diff --cached --name-only | grep '^TypeScript/' || true)
if [ -n "$SUBMODULE_CHANGES" ]; then
    echo ""
    echo "âŒ ERROR: Attempting to commit changes to TypeScript submodule!"
    echo ""
    echo "The TypeScript/ directory is a READ-ONLY git submodule."
    echo "You must NOT modify, add, or commit any files in this directory."
    echo ""
    echo "Blocked files:"
    echo "$SUBMODULE_CHANGES" | head -20
    if [ "$(echo "$SUBMODULE_CHANGES" | wc -l)" -gt 20 ]; then
        echo "... and more"
    fi
    echo ""
    echo "To unstage these changes:"
    echo "  git reset HEAD TypeScript/"
    exit 1
fi

SUBMODULE_POINTER=$(git diff --cached --name-only | grep '^TypeScript$' || true)
if [ -n "$SUBMODULE_POINTER" ]; then
    echo ""
    echo "âŒ ERROR: Attempting to change TypeScript submodule pointer!"
    echo "To unstage: git reset HEAD TypeScript"
    exit 1
fi

# â”€â”€â”€ Prerequisites â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if ! command -v cargo &>/dev/null; then
    echo "âŒ cargo not found"
    exit 1
fi

# Get changed Rust files
CHANGED_RS=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

# Nothing to do if no Rust files changed
if [ -z "$CHANGED_RS" ]; then
    echo "No Rust files changed, skipping checks."
    exit 0
fi

# â”€â”€â”€ 1. Clean stale target artifacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if [[ "$SKIP_CLEAN" != "1" ]]; then
    echo "1ï¸âƒ£  Cleaning stale target artifacts..."
    TARGET_DIR="$ROOT_DIR/target"
    if [ -d "$TARGET_DIR" ]; then
        # Remove doc artifacts (never needed at commit time)
        if [ -d "$TARGET_DIR/doc" ]; then
            rm -rf "$TARGET_DIR/doc"
            echo "   Removed target/doc"
        fi

        # Remove old nextest caches
        if [ -d "$TARGET_DIR/nextest" ]; then
            rm -rf "$TARGET_DIR/nextest"
            echo "   Removed target/nextest"
        fi

        echo "   âœ… Target cleanup done"
    fi
else
    echo "1ï¸âƒ£  Target cleanup skipped (TSZ_SKIP_CLEAN=1)"
fi

# â”€â”€â”€ 2. cargo fmt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo "2ï¸âƒ£  Formatting (cargo fmt)..."

# First, check if there are any formatting issues
if ! cargo fmt -- --check >/dev/null 2>&1; then
    # Auto-fix formatting
    cargo fmt
    echo "   Formatted files â€” auto-fixed."
else
    echo "   Already formatted."
fi

# â”€â”€â”€ 3. Clippy â€” deny all warnings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo "3ï¸âƒ£  Clippy (warnings are errors)..."

# Try auto-fix first, then verify
if ! cargo clippy --bins --lib --fix --allow-dirty --allow-staged -- -D warnings 2>/dev/null; then
    echo ""
    echo "âŒ Clippy found warnings/errors that could not be auto-fixed:"
    echo ""
    cargo clippy --bins --lib -- -D warnings 2>&1 | tail -50
    exit 1
fi

# Verify no warnings remain after auto-fix
CLIPPY_OUTPUT=$(cargo clippy --bins --lib -- -D warnings 2>&1) || {
    echo ""
    echo "âŒ Clippy warnings remain after auto-fix. Please fix manually:"
    echo "$CLIPPY_OUTPUT" | tail -20
    exit 1
}
echo "   âœ… Clippy passed (zero warnings)"

# â”€â”€â”€ Re-stage files modified by fmt / clippy auto-fix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

git add -u

# â”€â”€â”€ 4. Tests â€” run all â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo "4ï¸âƒ£  Running tests..."
TEST_OUTPUT=$(cargo nextest run --profile precommit 2>&1) || {
    echo "$TEST_OUTPUT" | tail -20
    echo "âŒ Tests failed. Run 'cargo nextest run' for details."
    exit 1
}
echo "$TEST_OUTPUT" | tail -5
echo "   âœ… Tests passed"

# â”€â”€â”€ 5. Microbenchmark regression check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if [[ "$SKIP_BENCH" == "1" ]]; then
    echo "5ï¸âƒ£  Microbenchmark check skipped (TSZ_SKIP_BENCH=1)"
else
    echo "5ï¸âƒ£  Microbenchmark regression check..."
    BENCH_CMD=("$ROOT_DIR/scripts/precommit-microbench.sh")
    if [[ "${TSZ_BENCH_UPDATE_BASELINE:-}" == "1" ]]; then
        BENCH_CMD+=("--update-baseline")
    fi

    BENCH_OUTPUT=$("${BENCH_CMD[@]}" 2>&1) || {
        echo "$BENCH_OUTPUT" | tail -30
        echo ""
        echo "âŒ Microbenchmark regression gate failed."
        echo "   To bypass (not recommended): TSZ_SKIP_BENCH=1 git commit ..."
        echo "   To refresh local baseline: TSZ_BENCH_UPDATE_BASELINE=1 git commit ..."
        exit 1
    }
    echo "$BENCH_OUTPUT" | tail -12
    echo "   âœ… Microbenchmark gate passed"
fi

# â”€â”€â”€ 6. Conformance regression check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if [[ "$SKIP_CONFORMANCE" == "1" ]]; then
    echo "6ï¸âƒ£  Conformance check skipped (TSZ_SKIP_CONFORMANCE=1)"
else
    echo "6ï¸âƒ£  Conformance regression check..."

    LAST_CONFORMANCE=""
    if LAST_CONFORMANCE=$("$ROOT_DIR/scripts/get-last-conformance.sh" 2>/dev/null); then
        echo "   Last recorded: ${LAST_CONFORMANCE}%"
    else
        echo "   No previous conformance found â€” skipping regression check."
        SKIP_CONFORMANCE=1
    fi

    if [[ "$SKIP_CONFORMANCE" != "1" ]]; then
        TEMP_OUTPUT=$(mktemp)
        trap 'rm -f "$TEMP_OUTPUT"' EXIT

        echo "   Running full conformance test suite..."
        if ! "$ROOT_DIR/scripts/conformance/run.sh" --pass-rate-only > "$TEMP_OUTPUT" 2>&1; then
            echo "âŒ Conformance tests failed to run"
            tail -20 "$TEMP_OUTPUT"
            exit 1
        fi

        # Extract current pass rate
        CURRENT_CONFORMANCE=$(sed -n '/===PASS_RATE_START===/,/===PASS_RATE_END===/p' "$TEMP_OUTPUT" | grep -oE '[0-9]+\.[0-9]+' | head -1)
        if [[ -z "$CURRENT_CONFORMANCE" ]]; then
            PASS_LINE=$(grep -E "^Pass Rate:" "$TEMP_OUTPUT" | tail -1)
            CURRENT_CONFORMANCE=$(echo "$PASS_LINE" | grep -oE '[0-9]+\.[0-9]+' | head -1)
        fi

        if [[ -z "$CURRENT_CONFORMANCE" ]]; then
            echo "âŒ Could not extract pass rate from conformance output"
            exit 1
        fi
        echo "   Current: ${CURRENT_CONFORMANCE}%"

        # Float comparison
        if command -v bc &>/dev/null; then
            IS_REGRESSION=$(echo "$CURRENT_CONFORMANCE < $LAST_CONFORMANCE" | bc -l)
        else
            CURRENT_INT=$(echo "$CURRENT_CONFORMANCE" | tr -d '.' | sed 's/^0*//')
            LAST_INT=$(echo "$LAST_CONFORMANCE" | tr -d '.' | sed 's/^0*//')
            [[ -z "$CURRENT_INT" ]] && CURRENT_INT=0
            [[ -z "$LAST_INT" ]] && LAST_INT=0
            if [[ "$CURRENT_INT" -lt "$LAST_INT" ]]; then
                IS_REGRESSION=1
            else
                IS_REGRESSION=0
            fi
        fi

        if [[ "$IS_REGRESSION" == "1" ]]; then
            echo ""
            echo "âŒ CONFORMANCE REGRESSION DETECTED!"
            echo ""
            echo "   Previous: ${LAST_CONFORMANCE}%"
            echo "   Current:  ${CURRENT_CONFORMANCE}%"
            echo "   Delta:    -$(echo "$LAST_CONFORMANCE - $CURRENT_CONFORMANCE" | bc -l 2>/dev/null || echo "?")%"
            echo ""
            echo "   Your changes caused a drop in conformance test pass rate."
            echo "   Please fix the regression before committing."
            echo ""
            echo "   To investigate:"
            echo "     ./scripts/conformance/run.sh --filter=<pattern> --print-test"
            echo ""
            echo "   To bypass (not recommended):"
            echo "     TSZ_SKIP_CONFORMANCE=1 git commit ..."
            echo ""
            exit 1
        fi

        echo "   âœ… Conformance: ${CURRENT_CONFORMANCE}% (no regression from ${LAST_CONFORMANCE}%)"

        # Store for prepare-commit-msg hook
        echo "$CURRENT_CONFORMANCE" > "$ROOT_DIR/.conformance-value"
    fi
fi

echo ""
echo "âœ… All pre-commit checks passed!"
