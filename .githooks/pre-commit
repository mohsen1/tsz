#!/bin/bash
#
# Pre-commit hook for tsz
# Runs formatting check, clippy, and unit tests before allowing commit
#

set -e

echo "ğŸ”§ Running pre-commit checks..."

# Check if cargo is available
if ! command -v cargo &> /dev/null; then
    echo "âŒ cargo not found. Please install Rust."
    exit 1
fi

# Check formatting
echo ""
echo "1ï¸âƒ£  Checking code formatting..."
if ! cargo fmt --check; then
    echo ""
    echo "âŒ Code is not formatted. Run: cargo fmt"
    exit 1
fi
echo "âœ… Formatting check passed"

# Run clippy (lib and bins only, skip tests that require Docker)
echo ""
echo "2ï¸âƒ£  Running clippy..."
if ! cargo clippy --bins --lib -- -D warnings; then
    echo ""
    echo "âŒ Clippy found issues. Please fix them before committing."
    echo "   Run: cargo clippy --bins --lib --fix --allow-dirty --allow-staged"
    exit 1
fi
echo "âœ… Clippy passed"

# Run unit tests (in Docker as required)
echo ""
echo "3ï¸âƒ£  Running unit tests..."
if ! ./scripts/test.sh >/dev/null 2>&1; then
    echo ""
    echo "âŒ Unit tests failed. Please fix them before committing."
    exit 1
fi
echo "âœ… Unit tests passed"

echo ""
echo "âœ… All pre-commit checks passed!"
