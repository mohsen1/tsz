#!/bin/bash
#
# Pre-commit hook for tsz
# Runs formatting check, clippy, and unit tests before allowing commit
#

set -e

echo "ğŸ”§ Running pre-commit checks..."

# Check if cargo is available
if ! command -v cargo &> /dev/null; then
    echo "âŒ cargo not found. Please install Rust."
    exit 1
fi

# Run formatting
echo ""
echo "1ï¸âƒ£  Running cargo fmt..."
cargo fmt
echo "âœ… Formatting applied"

# Run clippy with --fix (lib and bins only, skip tests that require Docker)
echo ""
echo "2ï¸âƒ£  Running clippy --fix..."
if ! cargo clippy --bins --lib --fix --allow-dirty --allow-staged -- -D warnings 2>/dev/null; then
    # If fix didn't resolve everything, run again to show errors
    echo ""
    echo "âš ï¸  Clippy found issues that couldn't be auto-fixed:"
    cargo clippy --bins --lib -- -D warnings
    exit 1
fi
echo "âœ… Clippy passed (auto-fixed where possible)"

# Re-add any files that were modified by fmt or clippy --fix
git add -u

# Run unit tests for changed files only (in Docker as required)
echo ""
echo "3ï¸âƒ£  Running unit tests for changed files..."
# Get list of changed Rust files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

if [ -n "$CHANGED_FILES" ]; then
    echo "   Changed files:"
    echo "$CHANGED_FILES" | sed 's/^/     - /'
    echo ""

    # Run tests with nextest filter based on changed files
    # Extract module names from file paths and run matching tests
    if ! ./scripts/test.sh >/dev/null 2>&1; then
        echo ""
        echo "âŒ Unit tests failed. Please fix them before committing."
        exit 1
    fi
    echo "âœ… Unit tests passed"
else
    echo "   No Rust files changed, skipping tests"
    echo "âœ… Skipped"
fi

echo ""
echo "âœ… All pre-commit checks passed!"
