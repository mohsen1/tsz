#!/bin/bash
#
# Pre-commit hook for tsz
# Runs formatting, clippy, builds (native + WASM), and targeted tests
# All checks use -D warnings to ensure no warnings slip through
#

set -e

# Skip hook if TSZ_SKIP_HOOKS is set (for automated commits)
[[ "${TSZ_SKIP_HOOKS:-}" == "1" ]] && exit 0

echo "ğŸ”§ Pre-commit checks..."

# ============================================================
# CRITICAL: Block any changes to TypeScript submodule
# ============================================================
SUBMODULE_CHANGES=$(git diff --cached --name-only | grep '^TypeScript/' || true)
if [ -n "$SUBMODULE_CHANGES" ]; then
    echo ""
    echo "âŒ ERROR: Attempting to commit changes to TypeScript submodule!"
    echo ""
    echo "The TypeScript/ directory is a READ-ONLY git submodule."
    echo "You must NOT modify, add, or commit any files in this directory."
    echo ""
    echo "Blocked files:"
    echo "$SUBMODULE_CHANGES" | head -20
    if [ "$(echo "$SUBMODULE_CHANGES" | wc -l)" -gt 20 ]; then
        echo "... and more"
    fi
    echo ""
    echo "To unstage these changes:"
    echo "  git reset HEAD TypeScript/"
    echo ""
    echo "If you need test files, create them in the project root (e.g., test_*.ts)"
    exit 1
fi

# Also check for submodule pointer changes
SUBMODULE_POINTER=$(git diff --cached --name-only | grep '^TypeScript$' || true)
if [ -n "$SUBMODULE_POINTER" ]; then
    echo ""
    echo "âŒ ERROR: Attempting to change TypeScript submodule pointer!"
    echo ""
    echo "Updating the submodule reference requires explicit approval."
    echo ""
    echo "To unstage: git reset HEAD TypeScript"
    exit 1
fi

# Check if cargo is available
if ! command -v cargo &> /dev/null; then
    echo "âŒ cargo not found"
    exit 1
fi

# Get changed Rust files upfront
CHANGED_RS=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

# Skip all checks if no Rust files changed
if [ -z "$CHANGED_RS" ]; then
    echo "No Rust files changed, skipping checks"
    exit 0
fi

# 1. Format only changed files (faster than formatting everything)
echo "1ï¸âƒ£  Formatting..."
echo "$CHANGED_RS" | xargs -r rustfmt --edition 2024 2>/dev/null || cargo fmt
echo "âœ… Formatted"

# 2. Run clippy (incremental, uses cached compilation)
echo "2ï¸âƒ£  Clippy..."
if ! cargo clippy --bins --lib --fix --allow-dirty --allow-staged -- -D warnings 2>/dev/null; then
    echo "âš ï¸  Clippy errors:"
    cargo clippy --bins --lib -- -D warnings 2>&1 | head -50
    exit 1
fi
echo "âœ… Clippy passed"

# Re-add files modified by fmt/clippy
git add -u

# 3. Build verification (native)
echo "3ï¸âƒ£  Building (native)..."
if ! RUSTFLAGS="-D warnings" cargo build --bins --lib 2>&1 | tail -20; then
    echo "âŒ Native build failed"
    exit 1
fi
echo "âœ… Native build passed"

# 4. Build verification (WASM)
echo "4ï¸âƒ£  Building (WASM)..."
if command -v wasm-pack &> /dev/null; then
    # Use local wasm-pack for speed
    if ! RUSTFLAGS="-D warnings" wasm-pack build --target nodejs 2>&1 | tail -20; then
        echo "âŒ WASM build failed"
        exit 1
    fi
else
    echo "   wasm-pack not found locally, using Docker..."
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
    if ! docker run --rm \
      -v "$PROJECT_ROOT:/source:ro" \
      -v "$PROJECT_ROOT/pkg:/output" \
      -v cargo-registry:/usr/local/cargo/registry \
      -v cargo-git:/usr/local/cargo/git \
      rust:latest sh -c "
        cargo install wasm-pack --locked 2>/dev/null
        mkdir -p /app
        cp -r /source/* /app/
        cd /app
        RUSTFLAGS='-D warnings' wasm-pack build --target nodejs
        cp -r /app/pkg/* /output/
      " 2>&1 | tail -20; then
        echo "âŒ WASM build failed"
        exit 1
    fi
fi
echo "âœ… WASM build passed"

# 5. Run targeted unit tests (--no-sandbox for speed, Docker used in CI)
echo "5ï¸âƒ£  Tests..."

# Extract module names for targeted test filtering
# e.g., src/checker/foo.rs -> checker, src/parser/bar.rs -> parser
MODULES=$(echo "$CHANGED_RS" | sed -n 's|^src/\([^/]*\)/.*\.rs$|\1|p' | sort -u | tr '\n' '|' | sed 's/|$//')

if [ -n "$MODULES" ]; then
    echo "   Modules: ${MODULES//|/, }"
    if ! ./scripts/test.sh --no-sandbox --quick "$MODULES" 2>&1 | tail -15; then
        echo "âŒ Tests failed. Run './scripts/test.sh' for details."
        exit 1
    fi
else
    # Non-module changes - quick sanity check with timeout
    echo "   Quick sanity check..."
    if ! ./scripts/test.sh --no-sandbox --quick --timeout=30 2>&1 | tail -10; then
        echo "âŒ Tests failed"
        exit 1
    fi
fi
echo "âœ… Tests passed"

echo "âœ… All checks passed!"
