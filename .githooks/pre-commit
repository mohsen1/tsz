#!/bin/bash
#
# Pre-commit hook for tsz - OPTIMIZED FOR SPEED
# Runs formatting, clippy, targeted tests, and conformance regression check
#

set -e

# Skip hook if TSZ_SKIP_HOOKS is set (for automated commits)
[[ "${TSZ_SKIP_HOOKS:-}" == "1" ]] && exit 0

# Skip conformance check if TSZ_SKIP_CONFORMANCE is set (for wip commits)
SKIP_CONFORMANCE="${TSZ_SKIP_CONFORMANCE:-}"

# Get root directory
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo "ðŸ”§ Pre-commit checks..."

# ============================================================
# CRITICAL: Block any changes to TypeScript submodule
# ============================================================
SUBMODULE_CHANGES=$(git diff --cached --name-only | grep '^TypeScript/' || true)
if [ -n "$SUBMODULE_CHANGES" ]; then
    echo ""
    echo "âŒ ERROR: Attempting to commit changes to TypeScript submodule!"
    echo ""
    echo "The TypeScript/ directory is a READ-ONLY git submodule."
    echo "You must NOT modify, add, or commit any files in this directory."
    echo ""
    echo "Blocked files:"
    echo "$SUBMODULE_CHANGES" | head -20
    if [ "$(echo "$SUBMODULE_CHANGES" | wc -l)" -gt 20 ]; then
        echo "... and more"
    fi
    echo ""
    echo "To unstage these changes:"
    echo "  git reset HEAD TypeScript/"
    echo ""
    echo "If you need test files, create them in the project root (e.g., test_*.ts)"
    exit 1
fi

# Also check for submodule pointer changes
SUBMODULE_POINTER=$(git diff --cached --name-only | grep '^TypeScript$' || true)
if [ -n "$SUBMODULE_POINTER" ]; then
    echo ""
    echo "âŒ ERROR: Attempting to change TypeScript submodule pointer!"
    echo ""
    echo "Updating the submodule reference requires explicit approval."
    echo ""
    echo "To unstage: git reset HEAD TypeScript"
    exit 1
fi

# Check if cargo is available
if ! command -v cargo &> /dev/null; then
    echo "âŒ cargo not found"
    exit 1
fi

# Get changed Rust files upfront
CHANGED_RS=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

# Skip all checks if no Rust files changed
if [ -z "$CHANGED_RS" ]; then
    echo "No Rust files changed, skipping checks"
    exit 0
fi

# 1. Format only changed files (faster than formatting everything)
echo "1ï¸âƒ£  Formatting..."
echo "$CHANGED_RS" | xargs -r rustfmt --edition 2024 2>/dev/null || cargo fmt
echo "âœ… Formatted"

# 2. Run clippy (incremental, uses cached compilation)
echo "2ï¸âƒ£  Clippy..."
if ! cargo clippy --bins --lib --fix --allow-dirty --allow-staged -- -D warnings 2>/dev/null; then
    echo "âš ï¸  Clippy errors:"
    cargo clippy --bins --lib -- -D warnings 2>&1 | head -50
    exit 1
fi
echo "âœ… Clippy passed"

# Re-add files modified by fmt/clippy
git add -u

# 3. Run targeted unit tests (--no-sandbox for speed, Docker used in CI)
echo "3ï¸âƒ£  Tests..."

# Extract module names for targeted test filtering
# e.g., src/checker/foo.rs -> checker, src/parser/bar.rs -> parser
MODULES=$(echo "$CHANGED_RS" | sed -n 's|^src/\([^/]*\)/.*\.rs$|\1|p' | sort -u | tr '\n' '|' | sed 's/|$//')

if [ -n "$MODULES" ]; then
    echo "   Modules: ${MODULES//|/, }"
    if ! ./scripts/test.sh --no-sandbox --quick "$MODULES" 2>&1 | tail -15; then
        echo "âŒ Tests failed. Run './scripts/test.sh' for details."
        exit 1
    fi
else
    # Non-module changes - quick sanity check with timeout
    echo "   Quick sanity check..."
    if ! ./scripts/test.sh --no-sandbox --quick --timeout=30 2>&1 | tail -10; then
        echo "âŒ Tests failed"
        exit 1
    fi
fi
echo "âœ… Tests passed"

# ============================================================
# 4. Conformance regression check (runs ALL tests)
# ============================================================
if [[ "$SKIP_CONFORMANCE" == "1" ]]; then
    echo "4ï¸âƒ£  Conformance check skipped (TSZ_SKIP_CONFORMANCE=1)"
else
    echo "4ï¸âƒ£  Conformance regression check (running ALL tests)..."
    
    # Get the last recorded conformance from git history
    LAST_CONFORMANCE=""
    if LAST_CONFORMANCE=$("$ROOT_DIR/scripts/get-last-conformance.sh" 2>/dev/null); then
        echo "   Last recorded: ${LAST_CONFORMANCE}%"
    else
        echo "   No previous conformance found in git history"
        echo "   Skipping regression check (baseline will be set with this commit)"
        SKIP_CONFORMANCE=1
    fi
    
    if [[ "$SKIP_CONFORMANCE" != "1" ]]; then
        # Run FULL conformance check (all tests)
        TEMP_OUTPUT=$(mktemp)
        trap "rm -f $TEMP_OUTPUT" EXIT
        
        echo "   Running full conformance test suite..."
        if ! "$ROOT_DIR/conformance/run.sh" --pass-rate-only > "$TEMP_OUTPUT" 2>&1; then
            echo "âŒ Conformance tests failed to run"
            cat "$TEMP_OUTPUT" | tail -20
            exit 1
        fi
        
        # Extract current pass rate from the marked output
        CURRENT_CONFORMANCE=$(sed -n '/===PASS_RATE_START===/,/===PASS_RATE_END===/p' "$TEMP_OUTPUT" | grep -oE '[0-9]+\.[0-9]+' | head -1)
        if [[ -z "$CURRENT_CONFORMANCE" ]]; then
            # Fallback: try to find Pass Rate line directly
            PASS_LINE=$(grep -E "^Pass Rate:" "$TEMP_OUTPUT" | tail -1)
            CURRENT_CONFORMANCE=$(echo "$PASS_LINE" | grep -oE '[0-9]+\.[0-9]+' | head -1)
        fi
        
        if [[ -z "$CURRENT_CONFORMANCE" ]]; then
            echo "âŒ Could not extract pass rate from conformance output"
            exit 1
        fi
        echo "   Current: ${CURRENT_CONFORMANCE}%"
        
        # Compare using bc for floating point comparison
        if command -v bc &>/dev/null; then
            IS_REGRESSION=$(echo "$CURRENT_CONFORMANCE < $LAST_CONFORMANCE" | bc -l)
        else
            # Fallback: compare as integers (multiply by 10 to preserve one decimal)
            CURRENT_INT=$(echo "$CURRENT_CONFORMANCE" | tr -d '.' | sed 's/^0*//')
            LAST_INT=$(echo "$LAST_CONFORMANCE" | tr -d '.' | sed 's/^0*//')
            [[ -z "$CURRENT_INT" ]] && CURRENT_INT=0
            [[ -z "$LAST_INT" ]] && LAST_INT=0
            if [[ "$CURRENT_INT" -lt "$LAST_INT" ]]; then
                IS_REGRESSION=1
            else
                IS_REGRESSION=0
            fi
        fi
        
        if [[ "$IS_REGRESSION" == "1" ]]; then
            echo ""
            echo "âŒ CONFORMANCE REGRESSION DETECTED!"
            echo ""
            echo "   Previous: ${LAST_CONFORMANCE}%"
            echo "   Current:  ${CURRENT_CONFORMANCE}%"
            echo "   Delta:    -$(echo "$LAST_CONFORMANCE - $CURRENT_CONFORMANCE" | bc -l 2>/dev/null || echo "?")%"
            echo ""
            echo "   Your changes caused a drop in conformance test pass rate."
            echo "   Please fix the regression before committing."
            echo ""
            echo "   To investigate:"
            echo "     ./conformance/run.sh --filter=<pattern> --print-test"
            echo ""
            echo "   To bypass (not recommended):"
            echo "     TSZ_SKIP_CONFORMANCE=1 git commit ..."
            echo ""
            exit 1
        fi
        
        echo "âœ… Conformance: ${CURRENT_CONFORMANCE}% (no regression from ${LAST_CONFORMANCE}%)"
        
        # Store the conformance value for the prepare-commit-msg hook to pick up
        echo "$CURRENT_CONFORMANCE" > "$ROOT_DIR/.conformance-value"
    fi
fi

echo "âœ… All checks passed!"
