#!/bin/bash
#
# Pre-commit hook for tsz - OPTIMIZED FOR SPEED
# Runs formatting, clippy, and targeted tests before commits
#

set -e

# Skip hook if TSZ_SKIP_HOOKS is set (for automated commits)
[[ "${TSZ_SKIP_HOOKS:-}" == "1" ]] && exit 0

echo "ğŸ”§ Pre-commit checks..."

# Check if cargo is available
if ! command -v cargo &> /dev/null; then
    echo "âŒ cargo not found"
    exit 1
fi

# Get changed Rust files upfront
CHANGED_RS=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

# Skip all checks if no Rust files changed
if [ -z "$CHANGED_RS" ]; then
    echo "No Rust files changed, skipping checks"
    exit 0
fi

# 1. Format only changed files (faster than formatting everything)
echo "1ï¸âƒ£  Formatting..."
echo "$CHANGED_RS" | xargs -r rustfmt --edition 2024 2>/dev/null || cargo fmt
echo "âœ… Formatted"

# 2. Run clippy (incremental, uses cached compilation)
echo "2ï¸âƒ£  Clippy..."
if ! cargo clippy --bins --lib --fix --allow-dirty --allow-staged -- -D warnings 2>/dev/null; then
    echo "âš ï¸  Clippy errors:"
    cargo clippy --bins --lib -- -D warnings 2>&1 | head -50
    exit 1
fi
echo "âœ… Clippy passed"

# Re-add files modified by fmt/clippy
git add -u

# 3. Run targeted unit tests (--no-sandbox for speed, Docker used in CI)
echo "3ï¸âƒ£  Tests..."

# Extract module names for targeted test filtering
# e.g., src/checker/foo.rs -> checker, src/parser/bar.rs -> parser
MODULES=$(echo "$CHANGED_RS" | sed -n 's|^src/\([^/]*\)/.*\.rs$|\1|p' | sort -u | tr '\n' '|' | sed 's/|$//')

if [ -n "$MODULES" ]; then
    echo "   Modules: ${MODULES//|/, }"
    if ! ./scripts/test.sh --no-sandbox --quick "$MODULES" 2>&1 | tail -15; then
        echo "âŒ Tests failed. Run './scripts/test.sh' for details."
        exit 1
    fi
else
    # Non-module changes - quick sanity check with timeout
    echo "   Quick sanity check..."
    if ! ./scripts/test.sh --no-sandbox --quick --timeout=30 2>&1 | tail -10; then
        echo "âŒ Tests failed"
        exit 1
    fi
fi
echo "âœ… Tests passed"

echo "âœ… All checks passed!"
