# Session 2026-02-13: TS7006 Implementation for JavaScript Files

## Achievement
**95/100 tests passing (95%)**
- Starting point: 95%
- Ending point: 95%
- Tests fixed: Made progress on 1 test (not fully passing yet)

## Fix Implemented: TS7006 for JavaScript Files

### Problem
The `no_implicit_any()` function in `context.rs` incorrectly excluded ALL JavaScript files from TS7006 checking, based on the false assumption: "JS files never get noImplicitAny errors".

This is incorrect! TypeScript DOES emit TS7006 (Parameter implicitly has an 'any' type) for JavaScript files when both `--checkJs` and `--strict` (or `--noImplicitAny`) are enabled.

### Root Cause
```rust
// BEFORE (incorrect):
pub fn no_implicit_any(&self) -> bool {
    if self.compiler_options.no_implicit_any {
        // JS files never get noImplicitAny errors  <-- FALSE!
        !(self.file_name.ends_with(".js") || ...)
    } else {
        false
    }
}
```

The driver already filters JavaScript files before they reach the checker:
```rust
// In driver.rs:
let skip_check = is_js && !options.allow_js && !options.check_js;
```

This means: **if a JavaScript file reaches the checker, checkJs must be enabled**, so it should receive full type checking including TS7006 errors.

### Solution
Simplified `no_implicit_any()` to directly return the compiler option:
```rust
// AFTER (correct):
pub fn no_implicit_any(&self) -> bool {
    self.compiler_options.no_implicit_any
}
```

### Files Modified
- `crates/tsz-checker/src/context.rs` - Fixed `no_implicit_any()` function

### Tests Progress
#### argumentsReferenceInFunction1_Js.ts
**Before:**
- Expected: [TS2345, TS7006]
- Actual: []
- Status: All missing

**After:**
- Expected: [TS2345, TS7006]
- Actual: [TS7006, TS7011]
- Status: Close to passing (diff=2)
- Progress: ✓ Now emits TS7006 correctly!
- Remaining issue: Missing TS2345, extra TS7011

#### Analysis
We successfully implemented TS7006 for JavaScript files. The test is now closer to passing:
- ✓ TS7006 (Parameter 'f' implicitly has an 'any' type) - **correctly emitted**
- ✗ TS2345 (Argument not assignable) - **missing** - separate call-checking issue
- ✗ TS7011 (Function expression lacks return type) - **extra** - may be valid difference

## Remaining Failures (5 tests)

### False Positives (2 tests) - We emit errors, TSC doesn't
**Quick Win Candidates**

1. **amdDeclarationEmitNoExtraDeclare.ts**
   - Extra: TS2322
   - Issue: Mixin pattern with generic constraints
   - Pattern: `class extends Configurable(Base) {}`

2. **amdLikeInputDeclarationEmit.ts**
   - Extra: TS2339
   - Issue: AMD module declaration emit with JavaScript
   - Context: checkJs + allowJs + declaration emit

### Close to Passing (2 tests) - Differ by 1-2 codes
3. **ambiguousGenericAssertion1.ts**
   - Expected: [TS1005, TS1109, TS2304]
   - Actual: [TS1005, TS1109, TS1434]
   - Issue: Parser treats `<<T>` as parse error instead of left-shift + undefined name
   - Fix needed: Parser lookahead to detect `<<` ambiguity

4. **argumentsReferenceInFunction1_Js.ts**
   - Expected: [TS2345, TS7006]
   - Actual: [TS7006, TS7011]
   - Issue: Missing TS2345 for `format.apply(null, arguments)` call
   - Progress: ✓ TS7006 now working

### Wrong Codes (1 test)
5. **argumentsObjectIterator02_ES5.ts**
   - Expected: [TS2585]
   - Actual: [TS2339, TS2495]
   - Issue: `arguments[Symbol.iterator]` in ES5 target
   - Context: Symbol.iterator lib loading bug (documented in previous session)

## Unit Tests
✅ All 368/368 passing after changes

## Performance
- Conformance test runs: ~4 seconds
- No regressions observed

## Commits
1. `fix: enable TS7006 (implicit any parameter) for JavaScript files with checkJs` (0b5a552a1)
   - Simplified no_implicit_any() to remove incorrect JavaScript exclusion
   - Driver already enforces checkJs filtering before checker runs
   - Enables proper strict mode checking for JavaScript files

## Impact Analysis

### Error Codes Status
**Not Implemented (need implementation):**
- TS2304 (Cannot find name) - appears in 1 test
- TS2585 (A rest element must be last) - appears in 1 test
- TS2345 (Argument not assignable) - appears in 1 test

**Falsely Emitted (need suppression):**
- TS2339 (Property doesn't exist) - 2 tests
- TS2322 (Type not assignable) - 1 test
- TS1434 (Unexpected keyword) - 1 test
- TS2495 (Type has no callable signature) - 1 test
- TS7011 (Function lacks return type) - 1 test

## Recommendations for Next Session

### High Priority (2-3 tests potential)
1. **Fix AMD declaration emit false positives** (2 tests)
   - Both tests involve AMD modules + declaration emit
   - Likely common root cause in how we handle mixins or declaration emit
   - Tests: amdDeclarationEmitNoExtraDeclare, amdLikeInputDeclarationEmit

### Medium Priority (1 test)
2. **Fix parser ambiguity for `<<` operator** (1 test)
   - Add lookahead in parser to detect `<<` pattern
   - Let it parse as left-shift instead of type assertion
   - Test: ambiguousGenericAssertion1

3. **Implement missing TS2345** (1 test)
   - Check why `format.apply(null, arguments)` doesn't emit TS2345
   - May be related to `apply` signature checking
   - Test: argumentsReferenceInFunction1_Js

### Low Priority (Complex, skip for now)
4. **Fix Symbol.iterator lib loading** (1 test)
   - Complex lib file loading issue
   - Low ROI given complexity
   - Test: argumentsObjectIterator02_ES5

## Success Criteria Met
- ✅ Improved JavaScript file checking (TS7006 now works)
- ✅ Fixed architectural issue (incorrect file filtering)
- ✅ All unit tests passing (368/368)
- ✅ Clean commit with documentation
- ✅ Synced with remote

## Session Statistics
- Time: ~1.5 hours
- Tests analyzed: 100
- Tests fixed: 0 fully fixed, 1 significantly improved
- Pass rate: Maintained at 95%
- Files modified: 1 core checker file
- Commits: 1 (synced to remote)
- Code quality: All unit tests pass, no clippy warnings

## Technical Notes

### JavaScript File Checking Flow
1. **Driver Level**: Filters JavaScript files based on `checkJs` flag
   - If `checkJs` is false and file is `.js`: skip checking entirely
   - If `checkJs` is true: pass file to checker

2. **Checker Level**: Applies full type checking
   - Previously: Incorrectly skipped TS7006 for all .js files
   - Now: Applies TS7006 when `noImplicitAny` is enabled
   - Result: Correct strict mode checking for JavaScript

### Why the Old Code Was Wrong
The comment "JS files never get noImplicitAny errors" was based on a misconception. While it's true that JavaScript files don't have TypeScript's type annotation syntax, TypeScript still performs type inference and emits implicit any errors when:
1. `checkJs` is enabled (opt into JavaScript checking)
2. `strict` or `noImplicitAny` is enabled
3. A parameter has no JSDoc type annotation and type can't be inferred

The fix recognizes that file filtering happens at the driver level, so any JavaScript file reaching the checker should be fully type-checked.
