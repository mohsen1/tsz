# Session: tsz-3 Critical Bug Review (2026-02-04)

**Status**: COMPLETED - Transitioned to implementation phase
**Duration**: 2026-02-04
**Outcome**: Found 8+ critical bugs, documented implementation plans

## Summary

Systematic review of the last 400 commits to identify type system bugs before continuing new feature work. Successfully identified and documented critical bugs in narrowing logic with implementation guidance from Gemini.

## Findings

### 1. Discriminant Narrowing (COMMIT: f2d4ae5d5)
**Bugs Found**: 3
- Reversed subtype check
- Missing type resolution (Lazy/Ref/Intersection)
- Broken for optional properties

**Resolution**: REVERTED commit

**Correct Approach**:
- Use filtering approach, not pre-discovery
- Use `resolve_property_access` for type resolution
- Check `is_subtype_of(literal, property_type)` - NOT reversed

---

### 2. instanceof Narrowing
**Bugs Found**: 1
- Returns NEVER for interface vs class checks

**Fix Required**:
- Use `intersection2(source, target)` instead of `narrow_to_type`

---

### 3. `in` Operator Narrowing
**Bugs Found**: 4+

1. **unknown handling**: Returns `unknown` instead of `object & { prop: unknown }`
2. **Optional properties**: Property stays optional instead of becoming required
3. **Missing resolution**: Doesn't handle Lazy/Ref types
4. **No intersection support**: Returns false for intersection types

**Fix Required**:
- Enhance `type_has_property` with resolution and intersection support
- Transform `narrow_by_property_presence` from filter to transformer
- Add `promote_optional_property` helper

---

## Impact

**Total Critical Bugs**: 8+
**Files Affected**: `src/solver/narrowing.rs`
**Type System Impact**: HIGH - narrowing is foundational to control flow analysis

## Next Phase

Session transitioned to **tsz-3: Narrowing Logic Correctness** for implementation of fixes.
See: `docs/sessions/tsz-3.md`

## Commits

- `d2d6c31cd`: Revert discriminant narrowing commit
- `b32ec4910`: Document review findings
- `acc62cd49`: Add implementation plan for in operator
- `fbfc3c8d5`: Redefine tsz-3 session
