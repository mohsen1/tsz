# Session tsz-2: Best Common Type (BCT) - Full Implementation

**Started**: 2026-02-04
**Focus**: Implement Rule #32 - Best Common Type algorithm with proper common base class detection and literal widening

## Problem Statement

The Best Common Type (BCT) algorithm is the foundation for type inference in:
- Array literals: `[1, 2]` → `number[]`
- Conditional expressions: `cond ? a : b` → common type
- Function return types: inferred from return statements

**Current Gap**: While `UnsoundnessAudit` marks BCT as "Fully Implemented," the actual code in `src/solver/infer.rs` reveals that the **Common Base Class** logic is a placeholder.

**Impact**: Without proper common base class detection:
```typescript
class Animal {}
class Dog extends Animal {}
class Cat extends Animal {}

const animals = [new Dog(), new Cat()];
// tsc infers: Animal[]
// tsz currently infers: Dog | Cat (union - WRONG)
```

This leads to "type not assignable" errors when the result is passed to functions expecting the base class.

## Tasks

### Task 1: Nominal Hierarchy Infrastructure
**Files**: `src/solver/db.rs`, `src/checker/state_type_analysis.rs`, `src/solver/infer.rs`

**Steps**:
1. Add `get_class_base_type(symbol_id: SymbolId) -> Option<TypeId>` to `TypeDatabase` trait
2. Implement in `CheckerState` to bridge Solver → Binder (query `extends` clause)
3. Refine `get_class_hierarchy` in `infer.rs` with robust traversal

### Task 2: Literal Widening Logic
**File**: `src/solver/infer.rs`

**Steps**:
1. Implement `widen_literal_type` - widen `1 | 2` to `number`
2. Respect `const` contexts (preserve literals)
3. Update `resolve_from_candidates` to integrate widening

### Task 3: Tournament Reduction Refinement
**File**: `src/solver/infer.rs`

**Steps**:
1. Optimize `best_common_type` with tournament algorithm
2. Handle interface merging
3. Handle `any`/`unknown` per tsc rules

### Task 4: Array Literal Integration
**File**: `src/solver/array_literal.rs`

**Steps**:
1. Update `ArrayLiteralBuilder` to use refined BCT logic
2. Ensure `build_array_type` uses `best_common_type`

## Success Criteria

- [ ] `get_class_base_type` added to TypeDatabase trait
- [ ] Common base class detection implemented
- [ ] Literal widening works: `[1, 2]` → `number[]`
- [ ] Nominal BCT works: `[dog, cat]` → `Animal[]`
- [ ] Union fallback preserved: `[1, "a"]` → `(string | number)[]`
- [ ] Homogeneous fast path preserved (performance)
- [ ] Conformance tests pass

## Complexity: HIGH

**Risk**: Changes to `is_subtype` or `best_common_type` can cause regressions

**Mandatory**: Follow **Two-Question Rule** in AGENTS.md before touching `src/solver/infer.rs`

---

## Next Steps

1. ✅ Session redefined with this plan
2. ⏸️ Ask Gemini Question 1 (Approach Validation)
3. ⏸️ Implement following Question 1 guidance
4. ⏸️ Ask Gemini Question 2 (Implementation Review)
5. ⏸️ Fix any issues found in review
6. ⏸️ Test and commit

---

## Previous Work: TDZ (2026-02-04) ✅

TDZ checking for static blocks, computed properties, and heritage clauses is complete.
See: `docs/sessions/history/tsz-2-tdz-20260204.md`

## Session History

- 2026-02-04: Started with TDZ focus
- 2026-02-04: Redefined to BCT work
- 2026-02-04: Ready for Question 1 (approach validation)
