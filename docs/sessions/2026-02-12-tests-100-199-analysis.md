# Tests 100-199 Analysis - Async/Await ES5 Focus

**Date**: 2026-02-12
**Target**: Second 100 conformance tests (--offset=100 --max=100)
**Primary Focus**: Async/await with ES5 target compilation

## Test Distribution Analysis

Tests 100-120 are **heavily concentrated** on async/await ES5 emit:

```
async/es5/asyncArrowFunction/
  - asyncArrowFunction9_es5.ts
  - asyncArrowFunctionCapturesArguments_es5.ts
  - asyncArrowFunctionCapturesThis_es5.ts
  - asyncUnParenthesizedArrowFunction_es5.ts

async/es5/
  - asyncAwait_es5.ts
  - asyncAwaitIsolatedModules_es5.ts
  - asyncAwaitNestedClasses_es5.ts
  - asyncClass_es5.ts
  - asyncConstructor_es5.ts
  - asyncDeclare_es5.ts
  - asyncEnum_es5.ts
  - asyncGetter_es5.ts
  - asyncImportedPromise_es5.ts
  - asyncInterface_es5.ts
  - asyncMethodWithSuper_es5.ts
  - asyncModule_es5.ts
  - asyncMultiFile_es5.ts
  - asyncQualifiedReturnType_es5.ts
  - asyncSetter_es5.ts
  - asyncUseStrict_es5.ts

async/es5/awaitBinaryExpression/
  - awaitBinaryExpression1-5_es5.ts

async/es5/awaitCallExpression/
  - awaitCallExpression1-5_es5.ts
```

## Key Implementation Areas

### 1. **Async Function ES5 Emit** ‚ö†Ô∏è Critical
ES5 doesn't support async/await natively. TypeScript compiles them to:
- Generator functions (__generator helper)
- State machines (switch statements)
- Promise wrapping (__awaiter helper)

**Required**:
- `__awaiter` helper emission
- `__generator` helper emission
- `__values` helper for iterators
- Proper state machine generation

**Location**: `crates/tsz-emitter/src/emit_es5.rs` or similar

### 2. **Async Arrow Functions** üî• High Priority
- `async () => await foo()` needs special handling
- `this` capture in async arrows
- `arguments` capture in async arrows

**Challenges**:
- Arrow functions don't have their own `this`
- Must capture from enclosing scope before async transform
- ES5 emit makes this even more complex

**Location**: Arrow function transform + async transform coordination

### 3. **Await Expressions in ES5**
Binary expressions: `await a + await b`
Call expressions: `await foo(await bar())`

These need to be sequenced properly in the state machine.

### 4. **Async Context Validation**
Already implemented in recent commits:
- ‚úÖ `check_for_await_statement()` (TS1103, TS1432)
- ‚úÖ Top-level await support check (TS1378)
- ‚úÖ Await expression validation

## Current Status

### Completed ‚úÖ
- Async context validation (TS1103, TS1308, TS1378, TS1432)
- Parser support for async/await syntax
- Type checking for async functions

### Missing ‚ö†Ô∏è
- **ES5 emit for async/await** - This is likely the blocker
- `__awaiter` helper generation
- `__generator` helper generation
- State machine generation for async functions

## Estimated Impact

If ES5 async/await emit is **completely missing**, tests 100-199 pass rate could be:
- **0-20%** without ES5 async emit
- **60-80%** with correct ES5 async emit

This is a **high-leverage** fix area.

## Recommended Action Plan

1. **Verify ES5 async emit exists** in crates/tsz-emitter
2. **If missing**: Implement ES5 async transform
   - Add __awaiter helper
   - Add __generator helper
   - Transform async functions to state machines
3. **If present but buggy**: Debug specific failures
   - Check helper emission
   - Verify state machine generation
   - Test this/arguments capture

## Build Constraints

**Current Blocker**: System memory prevents cargo builds (SIGKILL)

**Workaround Options**:
1. Use remote build server
2. Build with `CARGO_BUILD_JOBS=1` to limit memory
3. Analyze code statically to propose fixes
4. Test on system with more RAM

## Next Steps

Once build succeeds:
1. Run: `./scripts/conformance.sh run --max=100 --offset=100 --verbose`
2. Check first 5-10 failures
3. Identify if ES5 async emit is missing vs. buggy
4. Implement or fix based on findings
