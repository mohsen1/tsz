# TS2322 Extra Focus (2026-02-15)

## Parser Recovery Focus (update)

- Date: 2026-02-15
- Scope: focus parser-failure paths that were emitting TS2322 via checker assignment checks.

Code change made:

- `crates/tsz-checker/src/assignability_checker.rs`
  - Added parser-recovery suppression in assignability checks:
    - `should_suppress_assignability_for_parse_recovery`
    - `is_parse_recovery_anchor_node`
  - New suppression triggers:
    - existing empty-identifier placeholder nodes (`get_identifier_text == "")
    - proximity to recorded syntax parse-error positions
    - parser error flags on node/ancestor (`THIS_NODE_HAS_ERROR` / `THIS_NODE_OR_ANY_SUB_NODES_HAS_ERROR`)

Validation run:

- `./scripts/conformance.sh run --error-code 2322 --filter parse`
- 6 parser-related parser-mode failures remain:
  - TS2322 extras
    - `TypeScript/tests/cases/compiler/parseBigInt.ts`
    - `TypeScript/tests/cases/conformance/parser/ecmascript5/RealWorld/parserharness.ts`
    - `TypeScript/tests/cases/conformance/parser/ecmascript5/StrictMode/parserStrictMode3.ts`
    - `TypeScript/tests/cases/conformance/parser/ecmascript5/StrictMode/parserStrictMode3-negative.ts`
    - `TypeScript/tests/cases/conformance/parser/ecmascript5/parserRealSource14.ts`
  - TS2322 missing
    - `TypeScript/tests/cases/compiler/parseInvalidNullableTypes.ts`

- `./scripts/conformance.sh run --error-code 2322 --max 4000`
  - TS2322: `missing=52, extra=92`
  - net change in this slice: one fewer TS2322 extra than the earlier `--max 4000` baseline captured in this session.

Open follow-up:

- Remaining parser-mode TS2322s likely require parser/grammar-side adjustments (especially bigint mode and strict-mode assignment diagnostics), not further checker suppression.

## Status
- Commit completed: `3a7ea01d7`
- Validation: `./scripts/conformance.sh run --error-code 2322 --max 4000` (focused slice) and full run to establish global distribution
- Full run file: `/tmp/ts2322_run_all_verbose.txt`

## Full Slice Result (2026-02-15)
- Command: `./scripts/conformance.sh run --error-code 2322 --verbose`
- `Final Results: 8578/12555 passed (68.3%)`
- `Skipped: 7`
- `Timeout: 2 (exceeded 5s limit)`
- `TS2322: missing=245, extra=305`

### Extra TS2322 Breakdown
- `extra_2322`: `305`
- `missing_2322`: `245`
- `both` (TS2322 appears in both expected and actual, but other code mismatch remains): `151`
- Extra TS2322 with `expected == []`: `187`
- Extra TS2322 with only TS2322 (`expected: []`, `actual: [TS2322]`): `126`

### High-Signal Extra-Only Clusters
- Top config signals:
  - `strict: true` present in `93` extra-TS2322 cases
  - `noemit: true` present in `46`
  - `strict: true` + `noemit: true` appears in `35` expected-empty + TS2322-only cases
  - `declaration: true` present in `33`
  - `strict: false` present in `32`
  - `target: esnext` present in `21`
- Co-occurring extras when TS2322 is emitted unexpectedly:
  - `TS2339` (`28`)
  - `TS2345` (`26`)
  - `TS2769` (`7`)
  - `TS2304` (`6`)
  - `TS2461` (`6`)
  - `TS7053` (`6`)
  - `TS18050` (`6`)
- Most common expected-shape when extra TS2322 appears:
  - 187 cases where expected set is empty (pure false-positive pressure)
  - 118 where expected has other codes but not TS2322

### Representative Failures (TS2322 extra, no TS2322 expected)
1. `TypeScript/tests/cases/compiler/contextualComputedNonBindablePropertyType.ts`
2. `TypeScript/tests/cases/compiler/contextualTypeBasedOnIntersectionWithAnyInTheMix3.ts`
3. `TypeScript/tests/cases/compiler/contextualTypeOfIndexedAccessParameter.ts`
4. `TypeScript/tests/cases/compiler/contextualTypeShouldBeLiteral.ts`
5. `TypeScript/tests/cases/compiler/contextuallyTypedBooleanLiterals.ts`
6. `TypeScript/tests/cases/compiler/freshLiteralInference.ts`
7. `TypeScript/tests/cases/compiler/genericFunctionInference2.ts`
8. `TypeScript/tests/cases/compiler/higherOrderMappedIndexLookupInference.ts`
9. `TypeScript/tests/cases/compiler/instanceofNarrowReadonlyArray.ts`
10. `TypeScript/tests/cases/compiler/homomorphicMappedTypeIntersectionAssignability.ts`
11. `TypeScript/tests/cases/compiler/inferringAnyFunctionType1.ts`
12. `TypeScript/tests/cases/compiler/destructuringTypeGuardFlow.ts`
13. `TypeScript/tests/cases/compiler/divergentAccessors1.ts`

### Why this points to checker/synthetic assignability
- Many extra-TS2322 files are clustered under contextual typing / inference-heavy paths (`contextual*`, `infer*`, `generic*`, `function*`) with strict mode and noemit combos.
- Co-occurring `TS2345`/`TS2339`/`TS2769` suggests the same surface is often producing several high-level diagnostics where tsc would prefer a narrower set of assignability or contextuality errors.
- This is most consistent with assignability-gateway routing and contextual typing return flow rather than parser-level syntax handling.

### Prioritized next steps
1. Prioritize strict+noemit contextual-inference failures first:
   - `circular*`, `contextual*`, `genericFunctionInference*`, `infer*`, `destructuring*`
2. For each cluster, validate that TS2322 emission is entering through centralized `assignability` boundary, not ad-hoc local checks.
3. Reduce false-positive TS2345/TS2339 co-emission by narrowing fallback paths to return code from assignability reasons.
4. Add focused regression slices for the representative files above to lock intended TS2322 behavior.

## Parser-only correction (2026-02-15, follow-up)

- Follow-up parser command:
  - `./scripts/conformance.sh run --error-code 2322 --filter parser --verbose`
- Result:
  - `Final Results: 585/794 passed (73.7%)`
  - `Skipped: 0`
  - `Timeout: 1 (exceeded 5s limit)`
  - `Top Error Code Mismatches`: `TS2304`, `TS1005`, `TS1109`, ...
  - TS2322 does not appear in parser-top-mismatch list for this slice.
- Parser files `parserharness.ts` and `parserRealSource14.ts` no longer register TS2322 in parser-failure contexts.
- Regression lock:
  - `crates/tsz-checker/tests/repro_parserreal.rs` now asserts that TS2322 is absent at the parser recovery target checks for these two files.
