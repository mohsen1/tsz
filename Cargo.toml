[package]
name = "wasm"
version = "0.1.0"
edition = "2024"

[lib]
crate-type = ["cdylib", "rlib"]

[[bin]]
name = "tsz"
path = "src/bin/tsz.rs"
required-features = ["cli"]

[features]
default = ["cli"]
cli = []
legacy_ast = []

[dependencies]
anyhow = "1.0"
clap = { version = "4.5", features = ["derive"] }
colored = "2.1"
globset = "0.4"
notify = "6.1"
wasm-bindgen = "0.2"
serde = { version = "1.0", features = ["derive"] }
serde_json = { version = "1.0", features = ["preserve_order"] }
serde-wasm-bindgen = "0.6"
rustc-hash = "2.0"  # Fast hashing for integer keys (FxHashMap)
rayon = "1.10"  # Parallel iteration for multi-file parsing
memchr = "2.7"  # SIMD byte searching for string escaping
walkdir = "2.5"
smallvec = "1.13"
dashmap = "6.1"  # Lock-free concurrent HashMap for sharded type storage
# Phase 7.5: Query-based Structural Solver
# salsa = "0.25"  # Query-based incremental computation - disabled for now (requires nightly)
ena = "0.14"  # Union-Find for type unification
indexmap = "2.6"  # Deterministic iteration for structural keys (preserves insertion order)
bitflags = "2.6"  # Efficient TypeFlags for fast rejection

[dev-dependencies]
criterion = "0.5"

[[bench]]
name = "scanner_bench"
harness = false

[[bench]]
name = "parser_bench"
harness = false

[[bench]]
name = "emitter_bench"
harness = false

[[bench]]
name = "real_world_bench"
harness = false

[[bench]]
name = "solver_bench"
harness = false

[[bench]]
name = "cfa_bench"
harness = false

[[bench]]
name = "parallel_bench"
harness = false

[lints.rust]
unsafe_code = "warn"
rust_2024_compatibility = { level = "warn", priority = -1 }

[lints.clippy]
# Correctness - these are errors
correctness = { level = "deny", priority = -1 }

# Style - useful warnings
style = { level = "warn", priority = -1 }
dbg_macro = "warn"
empty_structs_with_brackets = "warn"
get_unwrap = "warn"

# Performance
perf = { level = "warn", priority = -1 }

# Complexity
complexity = { level = "warn", priority = -1 }

# Allow some that may be too noisy for this codebase. Revisit later to clean up code
too_many_arguments = "allow"
type_complexity = "allow"
collapsible_if = "allow"
collapsible_else_if = "allow"
use_self = "allow"
manual_let_else = "allow"
if_then_some_else_none = "allow"
bool_comparison = "allow"
redundant_closure_for_method_calls = "allow"
unnested_or_patterns = "allow"
map_unwrap_or = "allow"
option_if_let_else = "allow"
question_mark = "allow"
manual_map = "allow"
match_same_arms = "allow"
if_same_then_else = "allow"
manual_range_contains = "allow"
iter_cloned_collect = "allow"
explicit_into_iter_loop = "allow"
useless_vec = "allow"
deref_addrof = "allow"
useless_format = "allow"
clone_on_copy = "allow"
or_fun_call = "allow"
manual_strip = "allow"
field_reassign_with_default = "allow"
match_like_matches_macro = "allow"
collapsible_match = "allow"
needless_borrow = "allow"
explicit_deref_methods = "allow"
unnecessary_cast = "allow"
redundant_else = "allow"
derivable_impls = "allow"
ptr_arg = "allow"
needless_return = "allow"
manual_find = "allow"
only_used_in_recursion = "allow"
vec_init_then_push = "allow"
single_match = "allow"
redundant_pattern_matching = "allow"
manual_saturating_arithmetic = "allow"
should_implement_trait = "allow"
iter_on_single_items = "allow"
iter_on_empty_collections = "allow"
len_zero = "allow"
manual_div_ceil = "allow"
get_first = "allow"
iter_overeager_cloned = "allow"
redundant_closure = "allow"
bool_to_int_with_if = "allow"
map_or_option_bool = "allow"
unnecessary_to_owned = "allow"
iter_filter_is_ok = "allow"
iter_filter_is_some = "allow"
manual_is_ascii_check = "allow"
match_single_binding = "allow"
transmute_undefined_repr = "allow"
into_iter_without_iter = "allow"
option_map_unit_fn = "allow"
map_entry = "allow"
for_kv_map = "allow"
manual_while_let_some = "allow"
needless_option_as_deref = "allow"
unnecessary_lazy_evaluations = "allow"
iter_without_into_iter = "allow"
new_without_default = "allow"
explicit_iter_loop = "allow"
needless_range_loop = "allow"
manual_memcpy = "allow"
let_and_return = "allow"
char_lit_as_u8 = "allow"
manual_saturating_sub = "allow"
manual_checked_sub = "allow"
unreachable_code = "allow"
map_or_option = "allow"
iter_any_is_more_efficient = "allow"
uninit_assumed_init = "allow"
manual_filter_map = "allow"
empty_line_after_doc_comments = "allow"
unreachable_patterns = "allow"
unnecessary_fallible_conversions = "allow"
explicit_auto_deref = "allow"
mem_replace_with_default = "allow"
mixed_read_write_in_expression = "allow"
useless_conversion = "allow"
comparison_chain = "allow"
or_default = "allow"
unnecessary_unwrap = "allow"
while_let_on_iterator = "allow"
semicolon_if_nothing_returned = "allow"
clone_on_ref_ptr = "allow"
needless_pass_by_value = "allow"
trivially_copy_pass_by_ref = "allow"
