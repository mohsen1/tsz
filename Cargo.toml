[workspace]
members = ["crates/*"]
exclude = ["crates/.target"]
resolver = "3"

[workspace.package]
version = "0.1.0"
edition = "2024"
repository = "https://github.com/mohsenazimi/tsz"
license = "Apache"
authors = ["Mohsen Azimi <mohsen@users.noreply.github.com>"]

[workspace.dependencies]
# Internal workspace crates
tsz-common = { path = "crates/tsz-common" }
tsz-scanner = { path = "crates/tsz-scanner" }
tsz-parser = { path = "crates/tsz-parser" }
tsz-binder = { path = "crates/tsz-binder" }
tsz-solver = { path = "crates/tsz-solver" }
tsz-lowering = { path = "crates/tsz-lowering" }
tsz-checker = { path = "crates/tsz-checker" }
tsz-emitter = { path = "crates/tsz-emitter" }
tsz-lsp = { path = "crates/tsz-lsp" }
tsz-cli = { path = "crates/tsz-cli" }
tsz-wasm = { path = "crates/tsz-wasm" }

# External dependencies (shared versions)
anyhow = "1.0"
bitflags = "2.6"
clap = { version = "4.5", features = ["derive"] }
colored = "2.1"
console_error_panic_hook = "0.1"
criterion = "0.5"
dashmap = "6.1"
ena = "0.14"
fixedbitset = "0.4"
globset = "0.4"
indexmap = "2.6"
memchr = "2.7"
notify = "6.1"
once_cell = "1.19"
rayon = "1.10"
rustc-hash = "2.0"
serde = { version = "1.0", features = ["derive", "rc"] }
serde_json = { version = "1.0", features = ["preserve_order"] }
serde-wasm-bindgen = "0.6"
smallvec = "1.13"
tempfile = "3"
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter", "json"] }
tracing-tree = "0.4"
walkdir = "2.5"
wasm-bindgen = "0.2"

[workspace.lints.rust]
unsafe_code = "warn"
rust_2024_compatibility = { level = "warn", priority = -1 }

[workspace.lints.clippy]
# Correctness - these are errors
correctness = { level = "deny", priority = -1 }
# Style - useful warnings
style = { level = "warn", priority = -1 }
dbg_macro = "warn"
print_stderr = "warn"
empty_structs_with_brackets = "warn"
get_unwrap = "warn"
# Performance
perf = { level = "warn", priority = -1 }
# Complexity
complexity = { level = "warn", priority = -1 }
# Allow some that may be too noisy for this codebase
too_many_arguments = "allow"
type_complexity = "allow"
collapsible_if = "allow"
use_self = "allow"
redundant_closure_for_method_calls = "allow"
unnested_or_patterns = "allow"
map_unwrap_or = "allow"
option_if_let_else = "allow"
match_same_arms = "allow"
manual_range_contains = "allow"
explicit_into_iter_loop = "allow"
useless_vec = "allow"
deref_addrof = "allow"
field_reassign_with_default = "allow"
match_like_matches_macro = "allow"
collapsible_match = "allow"
explicit_deref_methods = "allow"
redundant_else = "allow"
derivable_impls = "allow"
only_used_in_recursion = "allow"
vec_init_then_push = "allow"
manual_saturating_arithmetic = "allow"
should_implement_trait = "allow"
iter_on_single_items = "allow"
iter_on_empty_collections = "allow"
iter_overeager_cloned = "allow"
redundant_closure = "allow"
match_single_binding = "allow"
transmute_undefined_repr = "allow"
into_iter_without_iter = "allow"
map_entry = "allow"
for_kv_map = "allow"
manual_while_let_some = "allow"
needless_option_as_deref = "allow"
unnecessary_lazy_evaluations = "allow"
iter_without_into_iter = "allow"
explicit_iter_loop = "allow"
needless_range_loop = "allow"
empty_line_after_doc_comments = "allow"
explicit_auto_deref = "allow"
mem_replace_with_default = "allow"
mixed_read_write_in_expression = "allow"
clone_on_ref_ptr = "allow"
needless_pass_by_value = "allow"

[package]
name = "tsz"
version.workspace = true
edition.workspace = true
autotests = false
description = "Core TypeScript compiler and type checker library"
repository.workspace = true
license.workspace = true
authors.workspace = true

[lib]
crate-type = ["rlib"]

[dependencies]
tsz-common = { workspace = true }
tsz-scanner = { workspace = true }
tsz-parser = { workspace = true }
tsz-binder = { workspace = true }
tsz-solver = { workspace = true }
tsz-lowering = { workspace = true }
tsz-checker = { workspace = true }
tsz-emitter = { workspace = true }
tsz-lsp = { workspace = true }
anyhow = { workspace = true }
wasm-bindgen = { workspace = true }
serde = { workspace = true }
serde_json = { workspace = true }
serde-wasm-bindgen = { workspace = true }
rustc-hash = { workspace = true }
rayon = { workspace = true }
memchr = { workspace = true }
smallvec = { workspace = true }
dashmap = { workspace = true }
fixedbitset = { workspace = true }
ena = { workspace = true }
indexmap = { workspace = true }
bitflags = { workspace = true }
tracing = { workspace = true }
once_cell = { workspace = true }

[dev-dependencies]
criterion = { workspace = true }
once_cell = { workspace = true }
tempfile = { workspace = true }

[profile.release]
# Fast compilation with decent runtime performance (for testing)
lto = false           # No LTO = much faster compilation
codegen-units = 16    # Parallel codegen = faster compilation
strip = false         # Keep symbols for debugging

[profile.dist]
# Maximum optimization for production binary (use: cargo build --profile dist)
inherits = "release"
lto = "fat"           # Full link-time optimization for smaller, faster binary
codegen-units = 1     # Single codegen unit for better optimization
strip = "symbols"     # Strip debug symbols to reduce binary size

[profile.dist-fast]
# Fast build + good runtime: balance between compile time and performance
# Use for: CI testing, quick benchmarks, faster conformance runs
# Build time: ~20-30% faster than dist, Runtime: ~95% of dist performance
inherits = "release"
lto = "thin"          # Faster than fat LTO, still good optimization
codegen-units = 16    # Parallel build (like release), unlike dist's serial build
strip = "debuginfo"   # Keep symbols for debugging, strip debug info only

[profile.dev-fast]
inherits = "dev"
opt-level = 2
debug = true

[profile.bench]
lto = "thin"

[[bench]]
name = "scanner_bench"
harness = false

[[bench]]
name = "parser_bench"
harness = false

[[bench]]
name = "emitter_bench"
harness = false

[[bench]]
name = "real_world_bench"
harness = false

[[bench]]
name = "solver_bench"
harness = false

[[bench]]
name = "cfa_bench"
harness = false

[[bench]]
name = "parallel_bench"
harness = false

[[bench]]
name = "union_reduction_bench"
harness = false

[[bench]]
name = "object_subtype_bench"
harness = false

[[bench]]
name = "phase_timing_bench"
harness = false

[lints]
workspace = true
