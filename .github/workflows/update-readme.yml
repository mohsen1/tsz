name: Update README

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *'

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: update-readme
  cancel-in-progress: false

jobs:
  update-readme:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Update README metrics
        run: |
          chmod +x scripts/update-readme.sh
          ./scripts/update-readme.sh

      - name: Check README changes
        id: check_readme
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No README changes"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Ensure automated PR label exists
        if: steps.check_readme.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh label create automated --color 0E8A16 --description "Automated README metric updates" --force

      - name: Close prior automated README PRs
        if: steps.check_readme.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          for pr in $(gh pr list --state open --json number,headRefName,labels --jq '.[] | select((.labels | map(.name) | index("automated") != null) or .headRefName == "ci/update-readme-metrics") | .number'); do
            gh pr close "$pr" --delete-branch --comment "Superseded by a newer automated README update run."
          done

      - name: Create README update pull request
        if: steps.check_readme.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.token }}
          commit-message: "docs: automated README metrics update"
          title: "docs: automated README metrics update"
          body: |
            Automated update of README metrics (conformance / fourslash / emit).

            This PR is generated by the scheduled workflow.
          base: main
          labels: automated
          branch: ci/update-readme-metrics
          add-paths: |
            README.md
          delete-branch: true
