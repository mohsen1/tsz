name: Update README

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: "Optional CI run id to pull metrics from"
        required: false
        type: string
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  actions: read

concurrency:
  group: update-readme
  cancel-in-progress: true

jobs:
  update-readme:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || github.token }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Resolve source CI run
        id: source_run
        env:
          GH_TOKEN: ${{ github.token }}
          INPUT_RUN_ID: ${{ github.event.inputs.run_id }}
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "run_id=${{ github.event.workflow_run.id }}" >> "$GITHUB_OUTPUT"
            echo "head_sha=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
            echo "Using triggering workflow_run id=${{ github.event.workflow_run.id }} sha=${{ github.event.workflow_run.head_sha }}"
            exit 0
          fi

          if [ -n "${INPUT_RUN_ID:-}" ]; then
            run_json=$(gh run view "$INPUT_RUN_ID" --json databaseId,headSha,workflowName,conclusion)
            conclusion=$(echo "$run_json" | jq -r '.conclusion')
            workflow=$(echo "$run_json" | jq -r '.workflowName')
            if [ "$workflow" != "CI" ]; then
              echo "ERROR: run $INPUT_RUN_ID is not a CI workflow run"
              exit 1
            fi
            if [ "$conclusion" != "success" ]; then
              echo "ERROR: run $INPUT_RUN_ID did not succeed (conclusion=$conclusion)"
              exit 1
            fi
            echo "run_id=$INPUT_RUN_ID" >> "$GITHUB_OUTPUT"
            echo "head_sha=$(echo "$run_json" | jq -r '.headSha')" >> "$GITHUB_OUTPUT"
            echo "Using manually provided CI run id=$INPUT_RUN_ID"
            exit 0
          fi

          latest_run_id=$(
            gh run list --workflow CI --branch main --limit 30 --json databaseId,conclusion \
              --jq 'map(select(.conclusion=="success")) | .[0].databaseId // empty'
          )
          if [ -z "$latest_run_id" ]; then
            echo "ERROR: no successful CI run found on main"
            exit 1
          fi

          latest_run_json=$(gh run view "$latest_run_id" --json headSha)
          echo "run_id=$latest_run_id" >> "$GITHUB_OUTPUT"
          echo "head_sha=$(echo "$latest_run_json" | jq -r '.headSha')" >> "$GITHUB_OUTPUT"
          echo "Using latest successful CI run id=$latest_run_id"

      - name: Download CI metrics artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ steps.source_run.outputs.run_id }}
          github-token: ${{ github.token }}
          pattern: ci-metrics-*
          merge-multiple: true
          path: .ci-metrics

      - name: Update README metrics
        run: |
          node scripts/update-readme-from-ci-metrics.mjs

      - name: Check README changes
        id: check_readme
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No README changes"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push README update to main
        if: steps.check_readme.outputs.changed == 'true'
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add README.md
          git commit -m "docs: automated README metrics update for ${{ steps.source_run.outputs.head_sha }}"

          # Rebase in case main moved while this workflow was running.
          git pull --rebase origin main
          git push origin HEAD:main
