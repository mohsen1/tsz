name: Update README Conformance

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-conformance:
    name: Update Conformance Progress
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-conformance-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-conformance-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: conformance/package.json

      - name: Install conformance dependencies
        run: cd conformance && npm install

      - name: Build WASM
        run: wasm-pack build --target nodejs --out-dir pkg

      - name: Fetch TypeScript conformance tests
        run: git submodule update --init --depth 1 -- TypeScript

      - name: Build conformance runner
        run: cd conformance && npm run build

      - name: Run conformance tests
        id: conformance
        run: |
          cd conformance
          set +e
          OUTPUT=$(timeout 1800 bash run-conformance.sh --all --workers=4 2>&1)
          EXIT_CODE=$?
          set -e

          echo "$OUTPUT"

          # Parse output for stats
          if echo "$OUTPUT" | grep -q "Pass Rate:"; then
            PASS_RATE=$(echo "$OUTPUT" | grep "Pass Rate:" | head -1 | sed -E 's/.*Pass Rate:[[:space:]]*([0-9.]+)%.*/\1/')
            PASSED=$(echo "$OUTPUT" | grep "Pass Rate:" | head -1 | sed -E 's/.*\(([0-9]+)\/([0-9]+)\).*/\1/')
            TOTAL=$(echo "$OUTPUT" | grep "Pass Rate:" | head -1 | sed -E 's/.*\(([0-9]+)\/([0-9]+)\).*/\2/')

            echo "pass_rate=$PASS_RATE" >> $GITHUB_OUTPUT
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Get TypeScript version
        id: ts_version
        run: |
          TS_VERSION=$(node -e "const v = require('./conformance/typescript-versions.json'); const m = Object.values(v.mappings)[0]; console.log(m?.npm || v.default?.npm || 'unknown')")
          echo "version=$TS_VERSION" >> $GITHUB_OUTPUT

      - name: Update README
        if: steps.conformance.outputs.success == 'true'
        run: |
          cd conformance
          node dist/update-readme.js \
            --passed=${{ steps.conformance.outputs.passed }} \
            --total=${{ steps.conformance.outputs.total }} \
            --pass-rate=${{ steps.conformance.outputs.pass_rate }} \
            --ts-version=${{ steps.ts_version.outputs.version }}

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: update conformance progress (${{ steps.conformance.outputs.passed }}/${{ steps.conformance.outputs.total }} tests passing)

          Pass rate: ${{ steps.conformance.outputs.pass_rate }}%
          TypeScript version: ${{ steps.ts_version.outputs.version }}

          [skip ci]"
          git push
