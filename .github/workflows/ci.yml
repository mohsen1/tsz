name: CI

on:
  push:
    branches: [main, rust, 'claude/**']
  pull_request:
    branches: [main, rust]

env:
  CARGO_TERM_COLOR: always
  RUST_TEST_TIMEOUT: 300

jobs:
  # ─── Detect which workspace crates changed ──────────────────────────────────
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      common: ${{ steps.filter.outputs.common }}
      scanner: ${{ steps.filter.outputs.scanner }}
      parser: ${{ steps.filter.outputs.parser }}
      binder: ${{ steps.filter.outputs.binder }}
      solver: ${{ steps.filter.outputs.solver }}
      checker: ${{ steps.filter.outputs.checker }}
      emitter: ${{ steps.filter.outputs.emitter }}
      lsp: ${{ steps.filter.outputs.lsp }}
      root: ${{ steps.filter.outputs.root }}
      any_rust: ${{ steps.filter.outputs.any_rust }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            common:
              - 'crates/tsz-common/**'
            scanner:
              - 'crates/tsz-scanner/**'
            parser:
              - 'crates/tsz-parser/**'
            binder:
              - 'crates/tsz-binder/**'
            solver:
              - 'crates/tsz-solver/**'
            checker:
              - 'crates/tsz-checker/**'
            emitter:
              - 'crates/tsz-emitter/**'
            lsp:
              - 'crates/tsz-lsp/**'
            root:
              - 'src/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
            any_rust:
              - '**/*.rs'
              - '**/Cargo.toml'
              - 'Cargo.lock'

  # ─── Lint (fast, always runs) ──────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: needs.changes.outputs.any_rust == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.6

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Check formatting
        run: cargo fmt --check

      - name: Run clippy
        run: cargo clippy --all-targets -- -D warnings || echo "Clippy warnings found (not failing build)"

  # ─── Build (needed for conformance + wasm tests) ──────────────────────────
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: changes
    if: needs.changes.outputs.any_rust == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.6

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Build release
        run: cargo build --release

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-build
          path: target/release/
          retention-days: 1

  # ─── Test: Foundation crates (common, scanner, parser) ─────────────────────
  # These are fast (~seconds) and run if any of them or their deps changed.
  test-foundation:
    name: "Test: Foundation (common, scanner, parser)"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: changes
    if: >-
      needs.changes.outputs.common == 'true' ||
      needs.changes.outputs.scanner == 'true' ||
      needs.changes.outputs.parser == 'true' ||
      needs.changes.outputs.root == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.6

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Test tsz-common
        run: cargo nextest run --profile ci -p tsz-common

      - name: Test tsz-scanner
        run: cargo nextest run --profile ci -p tsz-scanner || [ $? -eq 4 ]

      - name: Test tsz-parser
        run: cargo nextest run --profile ci -p tsz-parser

  # ─── Test: Binder ──────────────────────────────────────────────────────────
  test-binder:
    name: "Test: Binder"
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: changes
    if: >-
      needs.changes.outputs.common == 'true' ||
      needs.changes.outputs.scanner == 'true' ||
      needs.changes.outputs.parser == 'true' ||
      needs.changes.outputs.binder == 'true' ||
      needs.changes.outputs.root == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.6

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Test tsz-binder
        run: cargo nextest run --profile ci -p tsz-binder

  # ─── Test: Solver (largest crate, ~195K lines) ─────────────────────────────
  test-solver:
    name: "Test: Solver"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: changes
    if: >-
      needs.changes.outputs.common == 'true' ||
      needs.changes.outputs.scanner == 'true' ||
      needs.changes.outputs.parser == 'true' ||
      needs.changes.outputs.binder == 'true' ||
      needs.changes.outputs.solver == 'true' ||
      needs.changes.outputs.root == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.6

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Test tsz-solver
        run: cargo nextest run --profile ci -p tsz-solver

  # ─── Test: Checker (82K lines, depends on solver) ──────────────────────────
  test-checker:
    name: "Test: Checker"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: changes
    if: >-
      needs.changes.outputs.common == 'true' ||
      needs.changes.outputs.scanner == 'true' ||
      needs.changes.outputs.parser == 'true' ||
      needs.changes.outputs.binder == 'true' ||
      needs.changes.outputs.solver == 'true' ||
      needs.changes.outputs.checker == 'true' ||
      needs.changes.outputs.root == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.6

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Test tsz-checker
        run: cargo nextest run --profile ci -p tsz-checker

  # ─── Test: Emitter + LSP (leaf crates) ─────────────────────────────────────
  test-leaf:
    name: "Test: Emitter + LSP"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: >-
      needs.changes.outputs.emitter == 'true' ||
      needs.changes.outputs.lsp == 'true' ||
      needs.changes.outputs.checker == 'true' ||
      needs.changes.outputs.solver == 'true' ||
      needs.changes.outputs.binder == 'true' ||
      needs.changes.outputs.parser == 'true' ||
      needs.changes.outputs.scanner == 'true' ||
      needs.changes.outputs.common == 'true' ||
      needs.changes.outputs.root == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.6

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Test tsz-emitter
        run: cargo nextest run --profile ci -p tsz-emitter || [ $? -eq 4 ]

      - name: Test tsz-lsp
        run: cargo nextest run --profile ci -p tsz-lsp || [ $? -eq 4 ]

  # ─── Test: Root crate (wasm - integration tests) ──────────────────────────
  test-root:
    name: "Test: Root (wasm)"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [changes, build]
    if: needs.changes.outputs.root == 'true' || needs.changes.outputs.any_rust == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.6

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Test root crate
        run: cargo nextest run --profile ci -p wasm

  # ─── WASM build ────────────────────────────────────────────────────────────
  wasm-build:
    name: WASM Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: changes
    if: needs.changes.outputs.any_rust == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch TypeScript lib sources
        run: git submodule update --init --depth 1 -- TypeScript

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-wasm-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-wasm-
            ${{ runner.os }}-cargo-

      - name: Build WASM (nodejs target for conformance)
        run: wasm-pack build --target nodejs --out-dir pkg

      - name: Copy TypeScript lib files into pkg
        run: |
          if [ -d "TypeScript/src/lib" ]; then
            mkdir -p pkg/lib
            cp -R TypeScript/src/lib/. pkg/lib/
          else
            echo "TypeScript lib sources missing; skipping lib copy"
          fi

      - name: Upload WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm-pkg
          path: pkg/
          retention-days: 1

  # ─── Conformance ───────────────────────────────────────────────────────────
  conformance:
    name: Conformance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [changes, build]
    if: >-
      needs.changes.outputs.solver == 'true' ||
      needs.changes.outputs.checker == 'true' ||
      needs.changes.outputs.binder == 'true' ||
      needs.changes.outputs.common == 'true' ||
      needs.changes.outputs.root == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-build
          path: .target/release/

      - name: Make binaries executable
        run: chmod +x .target/release/tsz .target/release/tsz-conformance .target/release/generate-tsc-cache || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch TypeScript conformance tests
        run: git submodule update --init --depth 1 -- TypeScript || echo "No TypeScript submodule"

      - name: Get TypeScript version
        id: ts-version
        run: |
          TS_SHA=$(git rev-parse HEAD:TypeScript 2>/dev/null || echo "unknown")
          echo "sha=$TS_SHA" >> $GITHUB_OUTPUT
          echo "TypeScript SHA: $TS_SHA"

      - name: Try to restore TSC cache
        id: tsc-cache
        uses: actions/cache@v4
        with:
          path: tsc-cache-full.json
          key: tsc-cache-${{ steps.ts-version.outputs.sha }}

      - name: Install Rust (for crates/conformance build if needed)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache crates/conformance build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            crates/conformance/target
          key: ${{ runner.os }}-conformance-${{ hashFiles('crates/conformance/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-conformance-

      - name: Build conformance runner
        run: |
          cd crates/conformance
          cargo build --release
          mkdir -p ../.target/release
          cp target/release/tsz-conformance ../.target/release/ || true
          cp target/release/generate-tsc-cache ../.target/release/ || true

      - name: Run conformance tests (quick)
        run: |
          timeout 600 ./scripts/conformance.sh run --no-download --max 500 --workers 4 || {
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 124 ]; then
              echo "::warning::Conformance tests timed out"
              exit 1
            fi
            echo "::notice::Conformance tests completed with exit code $EXIT_CODE (not failing CI)"
            exit 0
          }

  # ─── Summary ───────────────────────────────────────────────────────────────
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, build, test-foundation, test-binder, test-solver, test-checker, test-leaf, test-root, wasm-build]
    if: always()
    steps:
      - name: Check results
        run: |
          # Only check jobs that actually ran (skip if skipped due to no changes)
          check_job() {
            local name="$1"
            local result="$2"
            if [ "$result" == "failure" ]; then
              echo "::error::$name failed"
              exit 1
            fi
          }

          check_job "Build" "${{ needs.build.result }}"
          check_job "Lint" "${{ needs.lint.result }}"
          check_job "Foundation Tests" "${{ needs.test-foundation.result }}"
          check_job "Binder Tests" "${{ needs.test-binder.result }}"
          check_job "Solver Tests" "${{ needs.test-solver.result }}"
          check_job "Checker Tests" "${{ needs.test-checker.result }}"
          check_job "Leaf Tests" "${{ needs.test-leaf.result }}"
          check_job "Root Tests" "${{ needs.test-root.result }}"
          check_job "WASM Build" "${{ needs.wasm-build.result }}"

          echo "All critical jobs passed (or were skipped because no relevant changes)!"
